package com.example.tablecompare;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.stereotype.Service;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.scheduling.annotation.Async;
import org.springframework.scheduling.annotation.EnableAsync;

import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

@SpringBootApplication
@EnableAsync
public class TableCompareApplication {

    public static void main(String[] args) {
        SpringApplication.run(TableCompareApplication.class, args);
    }

    /* ======================================================
       CONTROLLER (MVC â€” aligned with your HTML)
       ====================================================== */

    @Controller
    @RequestMapping("/compare")
    public static class CompareController {

        private final TableCompareService service;

        public CompareController(TableCompareService service) {
            this.service = service;
        }

        @GetMapping
        public String page(Model model) {
            model.addAttribute("request", new CompareRequest());
            return "compare";
        }

        /* START ASYNC JOB */
        @PostMapping
        public String start(@ModelAttribute CompareRequest request,
                            Model model) {

            String jobId = service.startAsyncCompare(request.tableName);

            model.addAttribute("jobId", jobId);
            return "progress";
        }

        /* PROGRESS API */
        @GetMapping("/progress/{jobId}")
        @ResponseBody
        public JobStatus progress(@PathVariable String jobId) {
            return service.getStatus(jobId);
        }

        /* SHOW RESULT */
        @GetMapping("/result")
        public String result(String cacheId, Model model) {

            TableDiffResponseDTO diff =
                    service.getResult(cacheId);

            model.addAttribute("diff", diff);
            model.addAttribute("request", new CompareRequest());

            return "compare";
        }
    }

    /* ======================================================
       SERVICE
       ====================================================== */

    @Service
    public static class TableCompareService {

        private final JdbcTemplate jdbcTemplate;

        public TableCompareService(JdbcTemplate jdbcTemplate) {
            this.jdbcTemplate = jdbcTemplate;
        }

        /* CACHE */
        private final Map<String, CachedResult> cache =
                new ConcurrentHashMap<>();

        private final Map<String, JobStatus> jobs =
                new ConcurrentHashMap<>();

        private static final long TTL = 15 * 60 * 1000;

        /* ================= START ================= */

        public String startAsyncCompare(String tableName) {

            String jobId = UUID.randomUUID().toString();

            jobs.put(jobId, new JobStatus("RUNNING", 0, null));

            runAsync(jobId, tableName);

            return jobId;
        }

        /* ================= ASYNC JOB ================= */

        @Async
        public void runAsync(String jobId, String tableName) {

            try {

                update(jobId, 20);

                TableDiffResponseDTO result =
                        compareTable(tableName);

                update(jobId, 80);

                String cacheId = UUID.randomUUID().toString();

                cache.put(cacheId, new CachedResult(result));

                jobs.put(jobId,
                        new JobStatus("DONE", 100, cacheId));

            } catch (Exception e) {
                jobs.put(jobId,
                        new JobStatus("FAILED", 0, null));
            }
        }

        private void update(String jobId, int progress) {
            jobs.put(jobId,
                    new JobStatus("RUNNING", progress, null));
        }

        public JobStatus getStatus(String id) {
            return jobs.get(id);
        }

        public TableDiffResponseDTO getResult(String cacheId) {
            cleanup();
            return cache.get(cacheId).data;
        }

        private void cleanup() {
            long now = System.currentTimeMillis();
            cache.entrySet().removeIf(e ->
                    now - e.getValue().createdAt > TTL);
        }

        /* ==================================================
           YOUR ORIGINAL COMPARE LOGIC (UNCHANGED)
           ================================================== */

        public TableDiffResponseDTO compareTable(String tableName) {

            // ðŸ”¥ keep your existing SQL implementation here
            // returning mock for now

            TableDiffResponseDTO dto = new TableDiffResponseDTO();
            dto.tableName = tableName;

            dto.summary = new DiffSummaryDTO();
            dto.summary.different = 2;

            dto.modifiedRows = new ArrayList<>();

            RowDiffDTO r = new RowDiffDTO();
            r.primaryKey = Map.of("id", 1);
            r.changedColumns = List.of(
                    new ColumnDiffDTO("salary", 100, 200)
            );

            dto.modifiedRows.add(r);

            dto.onlyInTestRows = List.of();
            dto.onlyInProdRows = List.of();

            return dto;
        }
    }

    /* ======================================================
       CACHE + DTO
       ====================================================== */

    static class CachedResult {
        TableDiffResponseDTO data;
        long createdAt = System.currentTimeMillis();
        CachedResult(TableDiffResponseDTO d){data=d;}
    }

    static class JobStatus {
        public String status;
        public int progress;
        public String cacheId;

        JobStatus(String s,int p,String c){
            status=s;progress=p;cacheId=c;
        }
    }

    /* ================= DTOs ================= */

    public static class CompareRequest {
        public String tableName;
    }

    public static class ColumnDiffDTO {
        public String columnName;
        public Object testValue;
        public Object prodValue;

        ColumnDiffDTO(){}
        ColumnDiffDTO(String c,Object t,Object p){
            columnName=c;testValue=t;prodValue=p;
        }
    }

    public static class RowDiffDTO {
        public Map<String,Object> primaryKey;
        public List<ColumnDiffDTO> changedColumns;
        public Map<String,Object> testRow;
        public Map<String,Object> prodRow;
    }

    public static class DiffSummaryDTO {
        public long different;
        public long onlyInTest;
        public long onlyInProd;
    }

    public static class TableDiffResponseDTO {
        public String tableName;
        public DiffSummaryDTO summary;
        public List<RowDiffDTO> modifiedRows;
        public List<RowDiffDTO> onlyInTestRows;
        public List<RowDiffDTO> onlyInProdRows;
    }
}
